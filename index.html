<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dynamic CSV Viewer</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- d3-dsv for CSV parsing -->
  <script src="https://d3js.org/d3-dsv.v2.min.js"></script>
  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.min.js"></script>
  <!-- Lodash for debounce -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <style>
    /* Generic colorful header styling */
    .gradient-header {
      background: linear-gradient(90deg, #ff4d4d, #ffffff, #4d79ff);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .drag-area {
      border: 2px dashed #93c5fd;
      transition: all 0.3s ease;
    }
    .drag-area.dragover {
      border-color: #2563eb;
      background-color: rgba(37, 99, 235, 0.1);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-10">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-5xl font-extrabold gradient-header">Dynamic CSV Viewer</h1>
      <p class="mt-2 text-blue-700 font-medium">
        Upload a CSV file below to search and filter records across all fields.
      </p>
    </div>

    <!-- File Upload Area -->
    <div id="dragArea" class="drag-area bg-white rounded-xl p-10 mb-10 shadow-lg cursor-pointer transition-colors text-center">
      <input type="file" id="fileInput" accept=".csv" class="hidden" />
      <div class="flex flex-col items-center text-blue-600">
        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <p id="fileStatus" class="text-lg">
          Drag &amp; drop your CSV file here or click to select a file
        </p>
        <div id="spinner" class="hidden mt-4 flex justify-center">
          <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
        </div>
      </div>
    </div>

    <!-- Remote CSV URL -->
    <div id="urlArea" class="bg-white rounded-xl p-6 mb-10 shadow-lg">
      <div class="flex flex-col sm:flex-row items-start sm:items-end gap-2">
        <input type="text" id="urlInput" class="flex-grow border border-blue-300 rounded p-2 w-full" placeholder="https://example.com/data.csv" />
        <button id="loadUrlBtn" class="px-4 py-2 bg-blue-500 text-white rounded">Load CSV from URL</button>
      </div>
      <p id="urlStatus" class="text-blue-700 mt-2"></p>
    </div>

    <!-- Filter Controls -->
    <div id="filterContainer" class="mb-6 hidden">
      <h2 class="text-xl font-semibold text-blue-800 mb-1">Filters</h2>
      <p class="text-xs text-blue-600 mb-2">Hold Ctrl (Cmd on Mac) to select multiple options</p>
      <div id="filters" class="flex flex-wrap gap-4">
        <!-- Filter dropdowns will be created dynamically -->
      </div>
    </div>

    <!-- Column Selector -->
    <div id="columnContainer" class="mb-6 hidden">
      <h2 class="text-xl font-semibold text-blue-800 mb-2">Visible Columns</h2>
      <div id="columnCheckboxes" class="flex flex-wrap gap-4">
        <!-- Column checkboxes will be created dynamically -->
      </div>
    </div>

    <!-- Search Bar -->
    <div class="bg-white rounded-full shadow-lg mb-6 px-6 py-4 flex items-center">
      <svg class="w-6 h-6 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
      </svg>
      <input type="text" id="searchInput"
             class="w-full focus:outline-none text-lg text-blue-900 placeholder-blue-400"
             placeholder="Search records..." disabled />
    </div>

    <!-- Layout and Pagination Controls -->
    <div id="controlsArea" class="mb-6 hidden">
      <div class="bg-white rounded-lg shadow-lg p-4 flex flex-wrap items-center justify-between gap-4">
        <!-- Layout Switcher -->
        <div class="flex items-center space-x-2">
          <label class="text-sm font-medium text-blue-800">Layout:</label>
          <select id="layoutSelect" class="border border-blue-300 rounded px-2 py-1">
            <option value="cards">Cards</option>
            <option value="table">Table</option>
            <option value="list">List</option>
            <option value="compact">Compact</option>
          </select>
        </div>
        
        <!-- Items per page -->
        <div class="flex items-center space-x-2">
          <label class="text-sm font-medium text-blue-800">Items per page:</label>
          <select id="itemsPerPageSelect" class="border border-blue-300 rounded px-2 py-1">
            <option value="10">10</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        
        <!-- Export button -->
        <button id="exportBtn" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Export Results
        </button>
      </div>
    </div>

    <!-- Results Area -->
    <div id="resultsArea" class="mb-10 hidden">
      <h2 class="text-2xl font-bold mb-4 text-blue-800">Search Results</h2>
      <div id="sortContainer" class="mb-4 flex flex-wrap gap-2"></div>
      <div id="resultsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div
      
      <!-- Pagination Controls -->
      <div id="pagination" class="mt-4 flex justify-between items-center">
        <button id="prevBtn" class="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50" disabled>
          Previous
        </button>
        <span id="pageInfo" class="text-blue-700"></span>
        <button id="nextBtn" class="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50" disabled>
          Next
        </button>
      </div>
      <div id="resultCount" class="mt-4 text-right text-sm text-blue-700"></div>
    </div>
  </div>

  <script>
    let csvData = [];
    let columns = [];
    let selectedColumns = [];
    let fuse = null;
    let currentResults = [];
    let currentPage = 1;
    let resultsPerPage = 25;
    let currentLayout = 'cards'; // 'cards', 'table', 'list', 'compact'
    let csvWorker = null;
    let filterCache = {}
    // DOM Elements
    const dragArea = document.getElementById('dragArea');
    const fileInput = document.getElementById('fileInput');
    const searchInput = document.getElementById('searchInput');
    const fileStatus = document.getElementById('fileStatus');
    const resultsArea = document.getElementById('resultsArea');

    const resultsContainer = document.getElementById('resultsContainer');
    const resultCount = document.getElementById('resultCount');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const pageInfo = document.getElementById('pageInfo');
    const filterContainer = document.getElementById('filterContainer');
    const filtersDiv = document.getElementById('filters');
    const urlInput = document.getElementById('urlInput');
    const loadUrlBtn = document.getElementById('loadUrlBtn');
    const urlStatus = document.getElementById('urlStatus');

    const sortContainer = document.getElementById('sortContainer');

    const spinner = document.getElementById('spinner');
    const layoutSelect = document.getElementById('layoutSelect');
    const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
    const exportBtn = document.getElementById('exportBtn');
    const controlsArea = document.getElementById('controlsArea');

    function showSpinner() {
      spinner.classList.remove('hidden');
    }

    function hideSpinner() {
      spinner.classList.add('hidden');
    }

    // Initialize web worker
    function initWorker() {
      // Temporarily disable web worker to test fallback
      csvWorker = null;
      /*
      if (typeof Worker !== 'undefined') {
        csvWorker = new Worker('csv-worker.js');
        csvWorker.onmessage = function(e) {
          const { type, data, message, progress } = e.data;

          switch (type) {
            case 'progress':
              fileStatus.textContent = `${message} (${progress}%)`;
              break;
            case 'csvParsed':
              handleCSVParsed(data);
              break;
            case 'csvChunk':
              handleCSVChunk(data);
              break;
            case 'filtersBuilt':
              handleFiltersBuilt(data);
              break;
            case 'dataFiltered':
              handleDataFiltered(data);
              break;
            case 'error':
              fileStatus.textContent = message;
              hideSpinner();
              break;
          }
        };
      }
      */
    }

    // Initialize worker on page load
    initWorker();

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dragArea.addEventListener(eventName, e => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    // Highlight drag area when file is over it
    ['dragenter', 'dragover'].forEach(eventName => {
      dragArea.addEventListener(eventName, () => dragArea.classList.add('dragover'));
    });
    // Remove highlight on dragleave/drop
    ['dragleave', 'drop'].forEach(eventName => {
      dragArea.addEventListener(eventName, () => dragArea.classList.remove('dragover'));
    });
    // Handle file drop
    dragArea.addEventListener('drop', e => {
      const file = e.dataTransfer.files[0];
      if (file && file.name.toLowerCase().endsWith('.csv')) {
        processFile(file);
      } else {
        fileStatus.textContent = 'Please upload a valid CSV file.';
      }
    });
    // Open file dialog on click
    dragArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) processFile(file);
    });


    // Process CSV file using web worker for better performance
      function processFile(file) {
        // Reset previous data and show spinner
        csvData = [];
        currentResults = [];
        filterCache = {};
        fileStatus.textContent = 'Reading file...';
        searchInput.disabled = true;
        resultsArea.classList.add('hidden');
        controlsArea.classList.add('hidden');
        filterContainer.classList.add('hidden');
        showSpinner();
        
        const reader = new FileReader();
        reader.onload = function(e) {
          
          const csvText = e.target.result;
          
          if (csvWorker) {
            // Use web worker for processing
            csvWorker.postMessage({
              type: 'parseCSV',
              data: { csvText, filename: file.name }
            });
          } else {
            // Fallback to main thread processing
            fallbackProcessFile(csvText, file.name);
          }
        };
        
        reader.onerror = function(error) {
          fileStatus.textContent = 'Error reading file: ' + error.message;
          hideSpinner();
        };
        
        reader.readAsText(file);
      }

      // Fallback processing for browsers without web worker support
      function fallbackProcessFile(csvText, filename) {
        setTimeout(() => {
          try {
            // Simple CSV parser as fallback if d3 isn't available
            let parsedData;
            if (typeof d3 !== 'undefined' && d3.csvParse) {
              parsedData = d3.csvParse(csvText);
            } else {
              // Simple CSV parsing fallback
              parsedData = parseCSVSimple(csvText);
            }
            
            if (parsedData.length === 0) {
              fileStatus.textContent = 'No records found in the CSV.';
              hideSpinner();
              return;
            }
            
            columns = Object.keys(parsedData[0] || {});
            
            // Initialize Fuse.js if available
            if (typeof Fuse !== 'undefined') {
              fuse = new Fuse(parsedData, {
                keys: columns,
                threshold: 0.4,
                distance: 100
              });
            }
            
            handleCSVParsed({
              csvData: parsedData,
              columns,
              totalRows: parsedData.length,
              filename,
              isComplete: true
            });
          } catch (error) {
            fileStatus.textContent = 'Error parsing CSV: ' + error.message;
            hideSpinner();
          }

          // Determine columns dynamically from the CSV header
          columns = Object.keys(csvData[0] || {});
          selectedColumns = [...columns];
          // (Optional advanced logic: Suppress a column if more than 60% of its cells are empty)
          // For now, we simply rely on per-record checking.

        }, 50);
      }

      // Simple CSV parser fallback
      function parseCSVSimple(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) return [];
        
        const headers = parseCsvLine(lines[0]);
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
          const values = parseCsvLine(lines[i]);
          if (values.length === headers.length) {
            const record = {};
            headers.forEach((header, index) => {
              record[header] = values[index] || '';
            });
            data.push(record);
          }
        }
        
        return data;
      }

      // Parse a single CSV line handling quotes
      function parseCsvLine(line) {
        const result = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"' && (i === 0 || line[i-1] === ',')) {
            inQuotes = true;
          } else if (char === '"' && inQuotes && (i === line.length - 1 || line[i+1] === ',')) {
            inQuotes = false;
          } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        
        result.push(current.trim());
        return result;
      }

      // Handle CSV parsing completion
      function handleCSVParsed(data) {
        csvData = data.csvData;
        columns = data.columns;
        
        // Initialize Fuse.js for search if available
        if (typeof Fuse !== 'undefined') {
          fuse = new Fuse(csvData, {
            keys: columns,
            threshold: 0.4,
            distance: 100
          });
        } else {
          fuse = null; // Will use simple search fallback
        }
        
        fileStatus.textContent = `Loaded ${data.totalRows} rows successfully.`;
        searchInput.disabled = false;
        resultsArea.classList.remove('hidden');
        controlsArea.classList.remove('hidden');
        
        // Build filters using worker if available
        if (csvWorker) {
          csvWorker.postMessage({
            type: 'buildFilters',
            data: { csvData, columns }
          });
        } else {
          buildFilters();

          // Build column visibility checkboxes
          buildColumnSelectors();

          buildSortButtons();

          // Set initial results to all records and display first page
          currentResults = csvData;
          currentPage = 1;
          displayResults();
        } catch (error) {
          console.error("CSV parse error:", error);
          fileStatus.textContent = 'Error parsing CSV: ' + error.message;

        }
  

      // Handle chunk processing (for large files)
      function handleCSVChunk(data) {
        // For now, we'll handle chunks simply by updating progress
        // In a more advanced implementation, we could stream results
        console.log(`Received chunk ${data.chunkIndex + 1}/${data.totalChunks}`);
      }

      // Handle filter options built by worker
      function handleFiltersBuilt(filterOptions) {
        filterCache = filterOptions;
        buildFiltersFromCache();
        filterContainer.classList.remove('hidden');
      }

      // Handle filtered data from worker
      function handleDataFiltered(filteredData) {
        currentResults = filteredData;
        currentPage = 1;
        displayResults();
      }

    // Build filter dropdowns from cached data
    function buildFiltersFromCache() {
      filtersDiv.innerHTML = "";
      Object.keys(filterCache).forEach(field => {
        const uniqueVals = filterCache[field];
        const select = document.createElement('select');
        select.id = `filter-${field}`;
        select.multiple = true;
        select.size = Math.min(5, uniqueVals.length + 1);
        select.className = "border border-blue-300 rounded p-1 h-32";
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = field + " (All)";
        defaultOption.selected = true;
        select.appendChild(defaultOption);
        
        uniqueVals.forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        });
        
        select.addEventListener('change', updateResults);
        
        const wrapper = document.createElement('div');
        wrapper.className = "flex flex-col";
        const label = document.createElement('label');
        label.htmlFor = select.id;
        label.className = "text-blue-800 text-sm font-medium";
        label.textContent = field;
        wrapper.appendChild(label);
        wrapper.appendChild(select);
        filtersDiv.appendChild(wrapper);
      });
    }

    // Fallback filter building for non-worker mode
    function buildFilters() {
      filtersDiv.innerHTML = "";
      columns.forEach(field => {
        const uniqueVals = Array.from(new Set(csvData.map(d => String(d[field] || "").trim()).filter(v => v !== "")))
                                .sort((a, b) => a.localeCompare(b));
        if (uniqueVals.length > 0) {
          filterCache[field] = uniqueVals;
        }
      });
      buildFiltersFromCache();
      filterContainer.classList.remove('hidden');
    }

    // Build clickable sort buttons for each column
    function buildSortButtons() {
      sortContainer.replaceChildren();
      columns.forEach(field => {
        const btn = document.createElement('button');
        btn.dataset.column = field;
        btn.className = "px-2 py-1 border border-blue-300 rounded text-sm bg-white";
        btn.addEventListener('click', () => {
          if (sortColumn === field) {
            sortAscending = !sortAscending;
          } else {
            sortColumn = field;
            sortAscending = true;
          }
          updateSortUI();
          displayResults();
        });
        sortContainer.appendChild(btn);
      });
      updateSortUI();
    }

    function updateSortUI() {
      Array.from(sortContainer.children).forEach(btn => {
        const col = btn.dataset.column;
        if (col === sortColumn) {
          btn.classList.add('bg-blue-100');
          btn.innerHTML = `${col} ${sortAscending ? '▲' : '▼'}`;
        } else {
          btn.classList.remove('bg-blue-100');
          btn.textContent = col;
        }
      });
    }

    let lastSortColumn = null;
    let lastSortAscending = null;

    function sortResults() {
      if (!sortColumn) return;
      // Skip sorting if the sort criteria haven't changed
      if (sortColumn === lastSortColumn && sortAscending === lastSortAscending) {
        return;
      }
      currentResults.sort((a, b) => {
        const valA = a[sortColumn];
        const valB = b[sortColumn];
        
        const isNumericA = !isNaN(Number(valA));
        const isNumericB = !isNaN(Number(valB));
        
        if (isNumericA && isNumericB) {
          // Numeric comparison
          return sortAscending ? valA - valB : valB - valA;
        } else {
          // String comparison (case-insensitive)
          const strA = String(valA || '').toLowerCase();
          const strB = String(valB || '').toLowerCase();
          if (strA < strB) return sortAscending ? -1 : 1;
          if (strA > strB) return sortAscending ? 1 : -1;
          return 0;
        }
      });

    }

    // Update results based on search input and filter selections
    function updateResults() {
      const term = searchInput.value.trim();
      let filtered;
      
      if (term === "") {
        filtered = csvData;
      } else if (fuse) {
        // Use Fuse.js for fuzzy search if available
        filtered = fuse.search(term).map(r => r.item);
      } else {
        // Simple text search fallback
        filtered = csvData.filter(record => {
          return columns.some(col => {
            const value = String(record[col] || '').toLowerCase();
            return value.includes(term.toLowerCase());
          });
        });
      }
      
      // Apply each filter
      columns.forEach(field => {
        const select = document.getElementById(`filter-${field}`);
        if (select) {
          const selectedVals = Array.from(select.selectedOptions)
                                   .map(opt => opt.value)
                                   .filter(v => v !== "");
          if (selectedVals.length > 0) {
            filtered = filtered.filter(record => {
              return selectedVals.includes(String(record[field]).trim());
            });
          }
        }
      });
      
      currentResults = filtered;
      currentPage = 1;
      displayResults();
    }

    // Escape RegExp special characters for building a search regex
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\$&');
    }

    // Escape HTML to prevent injection
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Highlight the search term within a value if present (case-insensitive)
    function highlightValue(value, term) {
      const str = String(value);
      if (!term) return escapeHtml(str);
      const regex = new RegExp(escapeRegExp(term), 'gi');
      let result = '';
      let lastIndex = 0;
      let match;
      while ((match = regex.exec(str)) !== null) {
        result += escapeHtml(str.slice(lastIndex, match.index));
        result += `<mark>${escapeHtml(match[0])}</mark>`;
        lastIndex = match.index + match[0].length;
      }
      result += escapeHtml(str.slice(lastIndex));
      return result;
    }

    // Display results in different layouts
    function displayResults() {
      resultsContainer.innerHTML = "";
      sortResults();
      const startIdx = (currentPage - 1) * resultsPerPage;
      const endIdx = startIdx + resultsPerPage;
      const pageResults = currentResults.slice(startIdx, endIdx);
      
      // Set container class based on layout
      switch (currentLayout) {
        case 'cards':
          resultsContainer.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6";
          displayCardsLayout(pageResults);
          break;
        case 'table':
          resultsContainer.className = "overflow-x-auto";
          displayTableLayout(pageResults);
          break;
        case 'list':
          resultsContainer.className = "space-y-2";
          displayListLayout(pageResults);
          break;
        case 'compact':
          resultsContainer.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2";
          displayCompactLayout(pageResults);
          break;
      }
      
      updatePaginationInfo();
    }

    function displayCardsLayout(pageResults) {
      const term = searchInput.value.trim();
      pageResults.forEach(record => {
        const card = document.createElement('div');
        card.className = "relative bg-white shadow-md rounded-lg p-4 border border-blue-200 hover:shadow-lg transition-shadow";
        const list = document.createElement('ul');
        list.className = "space-y-1";

        selectedColumns.forEach(col => {


          const value = record[col] || '';
          if (value.trim() === "") return;
          const item = document.createElement('li');
          const displayValue = highlightValue(String(value), term);
          item.innerHTML = `<span class="font-semibold text-red-600">${col}:</span> ${displayValue}`;
          list.appendChild(item);
        });
        
        card.appendChild(list);
        card.appendChild(createCopyButton(record));
        resultsContainer.appendChild(card);
      });
    }

    function displayTableLayout(pageResults) {
      const table = document.createElement('table');
      table.className = "min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden";
      
      // Create header
      const thead = document.createElement('thead');
      thead.className = "bg-blue-50";
      const headerRow = document.createElement('tr');
      
      columns.forEach(col => {
        const th = document.createElement('th');
        th.className = "px-4 py-2 text-left text-sm font-medium text-blue-800 border-b";
        th.textContent = col;
        headerRow.appendChild(th);
      });
      
      const actionsHeader = document.createElement('th');
      actionsHeader.className = "px-4 py-2 text-left text-sm font-medium text-blue-800 border-b";
      actionsHeader.textContent = "Actions";
      headerRow.appendChild(actionsHeader);
      
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Create body
      const tbody = document.createElement('tbody');
      const term = searchInput.value.trim();
      
      pageResults.forEach((record, index) => {
        const row = document.createElement('tr');
        row.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";
        
        columns.forEach(col => {
          const td = document.createElement('td');
          td.className = "px-4 py-2 text-sm border-b max-w-xs truncate";
          const value = record[col] || '';
          const displayValue = highlightValue(String(value), term);
          td.innerHTML = displayValue;
          td.title = String(value); // Show full text on hover
          row.appendChild(td);
        });
        
        const actionsCell = document.createElement('td');
        actionsCell.className = "px-4 py-2 text-sm border-b";
        actionsCell.appendChild(createCopyButton(record, 'text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600'));
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      resultsContainer.appendChild(table);
    }

    function displayListLayout(pageResults) {
      const term = searchInput.value.trim();
      pageResults.forEach(record => {
        const item = document.createElement('div');
        item.className = "bg-white p-3 rounded border border-gray-200 hover:bg-gray-50";
        
        const content = document.createElement('div');
        content.className = "flex justify-between items-start";
        
        const details = document.createElement('div');
        details.className = "flex-1";
        
        const mainInfo = [];
        columns.slice(0, 3).forEach(col => {
          const value = record[col] || '';
          if (value.trim() !== "") {
            const displayValue = highlightValue(String(value), term);
            mainInfo.push(`<span class="font-medium text-blue-800">${col}:</span> ${displayValue}`);
          }
        });
        
        details.innerHTML = mainInfo.join(' • ');
        content.appendChild(details);
        content.appendChild(createCopyButton(record, 'text-xs text-blue-600 hover:underline'));
        
        item.appendChild(content);
        resultsContainer.appendChild(item);
      });
    }

    function displayCompactLayout(pageResults) {
      const term = searchInput.value.trim();
      pageResults.forEach(record => {
        const card = document.createElement('div');
        card.className = "bg-white p-2 rounded border border-gray-200 text-sm hover:shadow-md transition-shadow";
        
        const primaryField = columns[0];
        const primaryValue = record[primaryField] || '';
        
        if (primaryValue.trim() !== "") {
          const title = document.createElement('div');
          title.className = "font-medium text-blue-800 truncate";
          title.innerHTML = highlightValue(String(primaryValue), term);
          title.title = String(primaryValue);
          card.appendChild(title);
        }
        
        const secondaryInfo = [];
        columns.slice(1, 3).forEach(col => {
          const value = record[col] || '';
          if (value.trim() !== "") {
            secondaryInfo.push(String(value));
          }
        });
        
        if (secondaryInfo.length > 0) {
          const subtitle = document.createElement('div');
          subtitle.className = "text-gray-600 text-xs truncate mt-1";
          subtitle.textContent = secondaryInfo.join(' • ');
          subtitle.title = secondaryInfo.join(' • ');
          card.appendChild(subtitle);
        }
        
        card.appendChild(createCopyButton(record, 'absolute top-1 right-1 text-xs text-gray-400 hover:text-blue-600'));
        card.classList.add('relative');
        resultsContainer.appendChild(card);
      });
    }

    function createCopyButton(record, className = 'absolute top-2 right-2 text-xs text-blue-600 hover:underline') {
      const copyBtn = document.createElement('button');
      copyBtn.type = 'button';
      copyBtn.textContent = 'Copy';
      copyBtn.className = className;
      copyBtn.addEventListener('click', () => {
        let rowText;
        if (typeof d3 !== 'undefined' && d3.csvFormatRow) {
          rowText = d3.csvFormatRow(columns.map(c => record[c]));
        } else {
          // Simple CSV row formatting fallback
          rowText = columns.map(c => {
            const value = String(record[c] || '');
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
              return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
          }).join(',');
        }
        
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(rowText);
        } else {
          const ta = document.createElement('textarea');
          ta.value = rowText;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          try { document.execCommand('copy'); } catch (err) {}
          document.body.removeChild(ta);
        }
      });
      return copyBtn;
    }

    function updatePaginationInfo() {
      const totalPages = Math.ceil(currentResults.length / resultsPerPage);
      resultCount.textContent = `Showing ${currentResults.length} result${currentResults.length === 1 ? "" : "s"}.`;
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      
      prevBtn.disabled = currentPage <= 1;
      nextBtn.disabled = currentPage >= totalPages;
    }

    // Pagination controls
    prevBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        displayResults();
      }
    });
    nextBtn.addEventListener('click', () => {
      const totalPages = Math.ceil(currentResults.length / resultsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        displayResults();
      }
    });
    
    // Handle search input (debounced)
    searchInput.addEventListener('input', _.debounce(updateResults, 300));

    // Layout switcher event listener
    layoutSelect.addEventListener('change', (e) => {
      currentLayout = e.target.value;
      displayResults();
    });

    // Items per page event listener
    itemsPerPageSelect.addEventListener('change', (e) => {
      resultsPerPage = parseInt(e.target.value);
      currentPage = 1;
      displayResults();
    });

    // Export functionality
    exportBtn.addEventListener('click', () => {
      if (currentResults.length === 0) {
        alert('No data to export');
        return;
      }
      
      let csvContent;
      if (typeof d3 !== 'undefined' && d3.csvFormat) {
        csvContent = d3.csvFormat(currentResults.map(record => {
          const cleanRecord = {};
          columns.forEach(col => {
            cleanRecord[col] = record[col] || '';
          });
          return cleanRecord;
        }));
      } else {
        // Simple CSV formatting fallback
        csvContent = formatCSVSimple(currentResults);
      }
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      
      if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'filtered_results.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });

    // Simple CSV formatting fallback
    function formatCSVSimple(data) {
      const header = columns.join(',');
      const rows = data.map(record => {
        return columns.map(col => {
          const value = String(record[col] || '');
          // Quote values that contain commas, quotes, or newlines
          if (value.includes(',') || value.includes('"') || value.includes('\n')) {
            return '"' + value.replace(/"/g, '""') + '"';
          }
          return value;
        }).join(',');
      });
      return [header, ...rows].join('\n');
    }
  </script>
</body>
</html>
